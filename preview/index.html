<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DS Preview &amp; Playground — Phase 14</title>
  <link rel="stylesheet" href="css/ds-preview.css">
  <link rel="stylesheet" href="css/playground.css">
  <!--
    ARCHITECTURE NOTE:
      ds-preview.css  →  compiled design system CSS (tokens + base + components + themes)
                         Uses @layer tokens, base, utilities, components, themes, adapters
      playground.css  →  preview shell chrome only (not part of the DS layer stack)

    PHASE 9 NOTE:
      All component sections are generated at runtime by registry-engine.js
      reading component.registry.json.  No hardcoded component markup exists
      in this file.  Adding a new component requires:
        1. Create component SCSS files
        2. Add entry to preview/data/component.registry.json
      No HTML edits required.
  -->
</head>
<body>

<!-- ===================================================================
     SHELL
     =================================================================== -->
<div class="pg-shell">

  <!-- ── Top bar ─────────────────────────────────────────────────────── -->
  <header class="pg-topbar" role="banner">
    <div class="pg-topbar__logo">
      <div class="pg-topbar__logo-mark" aria-hidden="true">DS</div>
      <div>
        <div class="pg-topbar__title">Design System</div>
        <div class="pg-topbar__subtitle">Preview &amp; Playground — Phase 14</div>
      </div>
    </div>

    <div class="pg-topbar__controls">
      <!-- Framework switcher — Phase 14 -->
      <div class="pg-framework-switcher" id="pg-framework-switcher" role="group" aria-label="Framework and library selection">
        <label class="sr-only" for="pg-framework-select">Framework</label>
        <select id="pg-framework-select" class="pg-theme-select" aria-label="Select framework" title="Framework">
          <option value="html">HTML</option>
          <option value="angular">Angular</option>
        </select>

        <label class="sr-only" for="pg-library-select">Component library</label>
        <select id="pg-library-select" class="pg-theme-select" aria-label="Select component library" title="Library" disabled>
          <option value="none">No library</option>
          <option value="primeng">PrimeNG</option>
        </select>

        <label class="sr-only" for="pg-version-select">Library version</label>
        <select id="pg-version-select" class="pg-theme-select" aria-label="Select library version" title="Version" disabled>
          <option value="17">v17</option>
          <option value="18">v18</option>
          <option value="19">v19</option>
          <option value="20">v20</option>
        </select>
      </div>

      <label class="sr-only" for="pg-theme-select">Theme</label>
      <select id="pg-theme-select" class="pg-theme-select" aria-label="Select theme">
        <option value="light">☀️ Light</option>
        <option value="dark">🌑 Dark</option>
      </select>

      <div class="pg-export-dropdown" id="pg-export-dropdown">
        <button
          id="pg-export-btn"
          class="pg-export-btn"
          type="button"
          aria-haspopup="true"
          aria-expanded="false"
          title="Export playground overrides">
          <span aria-hidden="true">↓</span> Export
        </button>
        <ul class="pg-export-menu" id="pg-export-menu" role="menu" hidden>
          <li role="none"><button role="menuitem" data-export="css">user-theme.css</button></li>
          <li role="none"><button role="menuitem" data-export="scss">_user-theme.scss</button></li>
          <li role="none"><button role="menuitem" data-export="json">overrides.json</button></li>
          <li role="none"><button role="menuitem" data-export="page">page.css</button></li>
          <li role="none" id="pg-export-adapter-item" hidden>
            <button role="menuitem" data-export="adapter">primeng-adapter.css</button>
          </li>
          <li role="none" id="pg-export-readme-item" hidden>
            <button role="menuitem" data-export="readme">README.txt</button>
          </li>
        </ul>
      </div>
    </div>
  </header>

  <!-- ── Left sidebar ────────────────────────────────────────────────── -->
  <nav class="pg-sidebar" aria-label="Component navigation">
    <div>
      <span class="pg-sidebar__section-label">Components</span>
      <!--
        REGISTRY-DRIVEN: nav items are injected by RegistryEngine.buildPreviewNav().
        No manual edits required when adding or removing components.
      -->
      <ul class="pg-nav" role="list" id="pg-nav-list">
        <li aria-hidden="true" style="padding:0.375rem 0.625rem;font-size:0.75rem;color:var(--semantic-color-text-disabled);">Loading…</li>
      </ul>
    </div>

    <div>
      <span class="pg-sidebar__section-label">Demonstrations</span>
      <ul class="pg-nav" role="list">
        <li>
          <button class="pg-nav__item" type="button" data-nav="badge-flow">
            📦 Badge addition flow
          </button>
        </li>
      </ul>
    </div>

    <div style="margin-top:auto;padding-top:1rem;border-top:1px solid var(--semantic-color-border-default);">
      <span class="pg-sidebar__section-label">Layer stack</span>
      <div style="font-size:0.625rem;line-height:1.9;font-family:var(--primitive-font-family-mono);color:var(--semantic-color-text-subtle);padding:0 0.375rem;">
        <div style="color:var(--semantic-color-text-disabled);">adapters</div>
        <div style="color:var(--semantic-color-text-subtle);">page</div>
        <div style="color:var(--semantic-color-text-subtle);">themes</div>
        <div style="color:var(--semantic-color-text-default);font-weight:600;">components ◀ preview</div>
        <div style="color:var(--semantic-color-text-subtle);">utilities</div>
        <div style="color:var(--semantic-color-text-subtle);">base</div>
        <div style="color:var(--semantic-color-text-subtle);">tokens</div>
      </div>
    </div>
  </nav>

  <!-- ── Main canvas ──────────────────────────────────────────────────── -->
  <!--
    REGISTRY-DRIVEN MAIN CANVAS
    All pg-component-section elements are injected here by:
      RegistryEngine.buildPreviewSections(document.getElementById('pg-main'))
    This element starts empty. The loading scaffold is removed after init.
  -->
  <main class="pg-main" id="pg-main" role="main">
    <!-- Loading scaffold — removed by init script after registry loads -->
    <div id="pg-loading-scaffold" style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:1rem;color:var(--semantic-color-text-subtle);">
      <div style="font-size:2rem;" aria-hidden="true">⟳</div>
      <p style="font-size:0.875rem;">Loading component registry…</p>
    </div>
    <!-- PLACEHOLDER: Do not add component sections here. Use component.registry.json -->
    <section class="pg-component-section" data-component="__placeholder__" aria-hidden="true" style="display:none;"></section>
    <!-- /END PLACEHOLDER: RegistryEngine.buildPreviewSections() injects here -->
  </main><!-- /pg-main -->


  <!-- ── Right panel ──────────────────────────────────────────────────── -->
  <aside class="pg-panel" aria-label="Token inspector and playground">

    <div class="pg-panel__tabs" role="tablist">
      <button class="pg-panel__tab is-active" type="button" role="tab" data-tab="tokens" aria-selected="true" id="tab-tokens">
        Tokens
      </button>
      <button class="pg-panel__tab" type="button" role="tab" data-tab="playground" aria-selected="false" id="tab-playground">
        Playground
      </button>
      <button class="pg-panel__tab" type="button" role="tab" data-tab="docs" aria-selected="false" id="tab-docs">
        Docs
      </button>
      <button class="pg-panel__tab" type="button" role="tab" data-tab="diff" aria-selected="false" id="tab-diff">
        Diff<span class="pg-diff-badge" id="pg-diff-badge" aria-hidden="true"></span>
      </button>
      <button class="pg-panel__tab" type="button" role="tab" data-tab="pages" aria-selected="false" id="tab-pages">
        Pages
      </button>
      <button class="pg-panel__tab" type="button" role="tab" data-tab="adapter" aria-selected="false" id="tab-adapter">
        Adapter
      </button>
    </div>

    <!-- Token table pane -->
    <div class="pg-panel__pane is-active" data-pane="tokens" role="tabpanel" aria-labelledby="tab-tokens">
      <input
        id="pg-token-search"
        class="pg-token-search"
        type="search"
        placeholder="Filter tokens…"
        aria-label="Filter token table">
      <table class="pg-token-table" aria-label="Component token mappings">
        <thead>
          <tr>
            <th scope="col">CSS Variable</th>
            <th scope="col">Chain</th>
            <th scope="col"><span class="sr-only">Actions</span></th>
          </tr>
        </thead>
        <tbody id="pg-token-table-body">
          <!-- Populated by playground.js renderTokenTable() -->
        </tbody>
      </table>
    </div>

    <!-- Playground pane -->
    <div class="pg-panel__pane" data-pane="playground" role="tabpanel" aria-labelledby="tab-playground">
      <div id="pg-playground-pane">
        <!-- Populated by playground.js renderPlaygroundControls() -->
      </div>
    </div>

    <!-- Docs pane -->
    <div class="pg-panel__pane" data-pane="docs" role="tabpanel" aria-labelledby="tab-docs">
      <div id="pg-docs-pane">
        <!-- Populated by playground.js renderDocs() -->
      </div>
    </div>

    <!-- Diff pane -->
    <div class="pg-panel__pane" data-pane="diff" role="tabpanel" aria-labelledby="tab-diff">
      <div id="pg-diff-pane">
        <p class="pg-playground-intro">No token overrides yet. Edit tokens in the Playground tab.</p>
      </div>
    </div>

    <!-- Pages pane -->
    <div class="pg-panel__pane" data-pane="pages" role="tabpanel" aria-labelledby="tab-pages">
      <div id="pg-pages-pane">
        <!-- Populated by playground.js renderPagesPane() -->
      </div>
    </div>

    <!-- Adapter pane — Phase 14 -->
    <div class="pg-panel__pane" data-pane="adapter" role="tabpanel" aria-labelledby="tab-adapter">
      <div id="pg-adapter-pane">
        <!-- Populated by playground.js renderAdapterPane() -->
      </div>
    </div>

  </aside><!-- /pg-panel -->

</div><!-- /pg-shell -->

<!-- Toast notification -->
<div id="pg-toast" class="pg-toast" role="status" aria-live="polite" aria-atomic="true"></div>

<!-- ===================================================================
     SCRIPTS
     Load order:
       1. token-registry.js    — synchronous, defines window.DS_TOKENS
       2. registry-engine.js   — synchronous, defines window.RegistryEngine (no data loaded yet)
       3. playground.js        — synchronous, defines window.PlaygroundEngine (not yet init)
       4. Init block           — async: loads JSON → builds DOM → starts playground
     =================================================================== -->
<script src="js/token-registry.js"></script>
<script src="js/registry-engine.js"></script>
<script src="js/playground.js"></script>

<script>
/* ============================================================
   PHASE 13 — REGISTRY-DRIVEN INIT SEQUENCE
   This is the single orchestration point.
   All component markup is generated by the registry engine.
   No component HTML may be added to this file.
   ============================================================ */
(async function () {
  'use strict';

  // 1. Load both JSON registries (component.registry.json + adapter.registry.json)
  await RegistryEngine.init();

  // 2. Remove loading scaffold
  const scaffold = document.getElementById('pg-loading-scaffold');
  if (scaffold) scaffold.remove();

  // 3. Build nav items from registry (replaces hardcoded list)
  RegistryEngine.buildPreviewNav(document.getElementById('pg-nav-list'));

  // 4. Build all component sections from registry (replaces hardcoded sections)
  RegistryEngine.buildPreviewSections(document.getElementById('pg-main'));

  // 5. Start the playground engine (token tables, right panel controls, navigation)
  if (window.PlaygroundEngine) {
    PlaygroundEngine.init();
  }

  // 6. Render badge-flow demo (Phase 7 historical demo — data from token-registry.js)
  if (window.PlaygroundEngine && PlaygroundEngine.renderBadgeFlowDemo) {
    PlaygroundEngine.renderBadgeFlowDemo();
  }

  // 7. Inject live badge override controls into badge-flow section
  _initLiveBadgeOverride();

})();

/* ============================================================
   LIVE BADGE OVERRIDE MINI-PLAYGROUND
   Injects interactive colour override demo into the badge-flow
   section after it is generated by the registry engine.
   Architecture note: this contains no token logic — it is
   a pure UI control that calls style.setProperty().
   ============================================================ */
function _initLiveBadgeOverride() {
  const flowSection = document.querySelector('[data-component="badge-flow"]');
  if (!flowSection) return;

  const ORIGINAL_SUCCESS_BG = '#40c057';

  const liveBlock = document.createElement('div');
  liveBlock.innerHTML = `
    <p class="pg-heading" style="margin-top:2rem">Live theme override demo</p>
    <p style="font-size:0.8125rem;color:var(--semantic-color-text-subtle);line-height:1.6;margin-bottom:1rem;">
      Change <code>--component-badge-success-bg</code> below to see how a user theme override
      flows through the entire component \u2014 the badge preview updates immediately because
      <code>document.documentElement.style.setProperty()</code> re-resolves the entire
      <code>var()</code> chain with zero rebuild required.
    </p>
    <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;margin-bottom:1.25rem;">
      <div style="display:flex;flex-direction:column;gap:0.375rem;">
        <label style="font-size:0.6875rem;font-weight:600;font-family:var(--primitive-font-family-mono);">--component-badge-success-bg</label>
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <input type="color" id="live-success-bg" value="#40c057"
            style="width:32px;height:28px;padding:2px;border:1px solid var(--semantic-color-border-default);border-radius:4px;cursor:pointer;"
            aria-label="Override success badge background">
          <input type="text" id="live-success-bg-text" value="#40c057"
            style="width:90px;padding:0.3rem 0.5rem;border:1px solid var(--semantic-color-border-default);border-radius:4px;font-family:var(--primitive-font-family-mono);font-size:0.75rem;background:var(--semantic-color-surface-base);color:var(--semantic-color-text-default);"
            aria-label="Override success badge background (text)">
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:0.5rem;">
        <span style="font-size:0.6875rem;font-weight:600;color:var(--semantic-color-text-subtle);">Live preview:</span>
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <span class="ds-badge ds-badge--success ds-badge--md"><span class="ds-badge__label">Active</span></span>
          <span class="ds-badge ds-badge--success ds-badge--subtle ds-badge--md"><span class="ds-badge__label">Active</span></span>
          <span class="ds-badge ds-badge--success ds-badge--dot ds-badge--md" aria-label="Online"></span>
        </div>
      </div>
      <button id="live-reset-btn" type="button"
        style="padding:0.375rem 0.75rem;border:1px solid var(--semantic-color-border-default);border-radius:var(--primitive-radius-md);background:none;color:var(--semantic-color-text-subtle);font-size:0.75rem;cursor:pointer;">
        \u21ba Reset
      </button>
    </div>
    <div class="pg-code">
      <pre id="live-code-output">/* Live override \u2014 updates as you change the colour picker above */
[data-theme="custom"] {
  --component-badge-success-bg: #40c057; /* user override */
}

/* The subtle border + dot automatically inherit
   from --component-badge-success-subtle-border
   which still resolves via semantic \u2192 primitive chain */</pre>
    </div>`;

  flowSection.appendChild(liveBlock);

  const colorInput = document.getElementById('live-success-bg');
  const textInput  = document.getElementById('live-success-bg-text');
  const resetBtn   = document.getElementById('live-reset-btn');
  const codeOutput = document.getElementById('live-code-output');

  if (!colorInput || !textInput) return;

  function applyOverride(val) {
    document.documentElement.style.setProperty('--component-badge-success-bg', val);
    if (codeOutput) {
      codeOutput.textContent = `/* Live override — updates as you change the colour picker above */\n[data-theme="custom"] {\n  --component-badge-success-bg: ${val}; /* user override */\n}\n\n/* The subtle border + dot automatically inherit\n   from --component-badge-success-subtle-border\n   which still resolves via semantic → primitive chain */`;
    }
  }

  colorInput.addEventListener('input', e => { textInput.value = e.target.value; applyOverride(e.target.value); });
  textInput.addEventListener('change', e => { colorInput.value = e.target.value; applyOverride(e.target.value); });

  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      colorInput.value = ORIGINAL_SUCCESS_BG;
      textInput.value  = ORIGINAL_SUCCESS_BG;
      document.documentElement.style.removeProperty('--component-badge-success-bg');
      if (codeOutput) {
        codeOutput.textContent = `/* Property reset — browser resolves from @layer components */\n:root {\n  --component-badge-success-bg:\n    var(--semantic-color-feedback-success-default);\n  /* → var(--primitive-color-green-600) → #40c057 */\n}`;
      }
    });
  }
}
</script>

<!-- spin keyframe for loading indicator -->
<style>
  @keyframes spin { to { transform: rotate(360deg); } }
  #pg-loading-scaffold div:first-child { animation: spin 1.2s linear infinite; }
</style>

</body>
</html>
